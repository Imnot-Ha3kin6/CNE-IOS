name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Find Xcode Project
      run: |
        xcodeproj_path=$(find . -name "*.xcodeproj" -type d | head -1)
        
        if [ -z "$xcodeproj_path" ]; then
          echo "ERROR: No .xcodeproj folder found!"
          ls -la
          exit 1
        fi
        
        echo "Found Xcode project: $xcodeproj_path"
        echo "XCODEPROJ_PATH=$xcodeproj_path" >> $GITHUB_ENV

    - name: List Project Info
      run: |
        echo "Project information:"
        xcodebuild -project "$XCODEPROJ_PATH" -list

    - name: Build Main Target Only
      timeout-minutes: 30
      run: |
        project_name=$(basename "$XCODEPROJ_PATH" .xcodeproj)
        echo "Building target: $project_name"
        
        mkdir -p build/archives
        archive_path="build/archives/${project_name}.xcarchive"
        
        # Build only the main target, skip Build Haxe
        xcodebuild archive \
          -project "$XCODEPROJ_PATH" \
          -scheme "$project_name" \
          -configuration Release \
          -destination "generic/platform=iOS" \
          -archivePath "$archive_path" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          -skipUnavailableActions \
          -allowProvisioningUpdates
        
        echo "ARCHIVE_PATH=$archive_path" >> $GITHUB_ENV
        
        if [ -d "$archive_path" ]; then
          echo "Archive created successfully"
          find "$archive_path" -name "*.app"
        else
          echo "Archive creation failed"
          exit 1
        fi

    - name: Create IPA
      run: |
        mkdir -p build/export
        
        app_path=$(find "$ARCHIVE_PATH" -name "*.app" | head -1)
        
        if [ -z "$app_path" ]; then
          echo "No .app found in archive"
          exit 1
        fi
        
        echo "Found app: $app_path"
        
        mkdir -p build/export/Payload
        cp -r "$app_path" build/export/Payload/
        
        cd build/export
        zip -r CodenameEngine-unsigned.ipa Payload/
        cd ../..
        
        echo "IPA created successfully"

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ios-unsigned-ipa
        path: build/export/*.ipa
        if-no-files-found: error