name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode 15.4
      run: sudo xcode-select --switch /Applications/Xcode_15.4.app

    - name: Fix missing make
      run: |
        sudo mkdir -p /Applications/Xcode_15.4.app/Contents/Developer/usr/bin
        sudo ln -sf /usr/bin/make /Applications/Xcode_15.4.app/Contents/Developer/usr/bin/make

    - name: Find Xcode Project
      run: |
        xcodeproj_path=$(find . -name "*.xcodeproj" -type d | head -1)
        if [ -z "$xcodeproj_path" ]; then
          echo "ERROR: No .xcodeproj folder found!"
          ls -la
          exit 1
        fi
        echo "XCODEPROJ_PATH=$xcodeproj_path" >> $GITHUB_ENV

    - name: Archive iOS App
      run: |
        xcodebuild archive \
          -project "$XCODEPROJ_PATH" \
          -scheme "CodenameEngine" \
          -configuration Release \
          -archivePath build/CodenameEngine.xcarchive \
          -destination "generic/platform=iOS" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          ARCHS="arm64" \
          ONLY_ACTIVE_ARCH=NO
        echo "ARCHIVE_PATH=build/CodenameEngine.xcarchive" >> $GITHUB_ENV

    - name: Create IPA
      run: |
        mkdir -p build/export/Payload
        app_path=$(find "$ARCHIVE_PATH/Products/Applications" -name "*.app" | head -1)
        if [ -z "$app_path" ]; then
          echo "No .app found in archive"
          exit 1
        fi
        cp -r "$app_path" build/export/Payload/
        cd build/export
        zip -r CodenameEngine.ipa Payload
        cd ../..

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa
        path: build/export/*.ipa
        if-no-files-found: error
